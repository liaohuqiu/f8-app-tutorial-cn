<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<meta property="og:url" content="http://f8-app-tutorial-cn.liaohuqiu.net/tutorials/building-the-f8-app/testing/" />
	<meta property="og:site_name" content="Facebook React Native 教程"/>
	<meta property="og:title" content="Facebook React Native 教程" />
	<meta property="og:image" content="http://f8-app-tutorial-cn.liaohuqiu.net/static/og_image.png" />
	<meta property="og:description" content="探索如何使用 Nuclide，Flow，以及 Jest，以提高编写 React Native 时的代码质量。" />
  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css">
  <link rel="stylesheet" type="text/css" media="screen" href="//cdn.jsdelivr.net/font-hack/2.019/css/hack.min.css">

  <link rel="icon" href="static/favicon_junction.png" type="image/x-icon">

  <base href="/" />

  <script src="https://fb.me/react-with-addons-0.13.1.min.js"></script>

  <title>测试 &mdash; Facebook React Native 教程</title>
  <meta name="description" content="  这一系列的教程写于 F8 2016 app 开发期间，为的是用简单的文字来介绍 React Native 及其开源生态。教程于 2016 年 4 月 13 号发布到 makeitopen.com，内容翔实很有指导意义，我 看了之后花了周六日两天时间，翻译成中文，方便大家学习。">

  <link rel="canonical" href="http://f8-app-tutorial-cn.liaohuqiu.net/tutorials/building-the-f8-app/testing/">
  <link rel="alternate" type="application/rss+xml" title="Facebook React Native 教程" href="http://f8-app-tutorial-cn.liaohuqiu.net/feed/" />
</head>

  <body>
    <div id="fixed_header" class="fixedHeaderContainer visible">
  <header>
    <a href="/">
      <img src="/static/logo_square_small.png">
      <h2>构建 Facebook F8 2016 App / React Native 开发指南</h2>
    </a>

    <div class="navigationWrapper navigationFull" id="flat_nav">
      <nav class="navigation">
        <ul>
          
        </ul>
      </nav>
    </div>
  </header>
</div>

    <div class="navPusher">
      
<div class="mainContainer blogContainer postContainer">
  <div id="main_wrap" class="wrapper mainWrapper">
    
<div class="post">
  <header class="post-header">
    <h2 class="postSubtitle">
      <span>构建 F8 2016 App: 第四章</span>
      测试
    </h2>
    <div class="postPlugins">
      <div class="pluginBlock">
        <a href="https://twitter.com/share" class="twitter-share-button" data-hashtags="测试">Tweet</a>
      </div>
      <div class="fb-like" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true"></div>
    </div>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <script>
      window.fbAsyncInit = function() {
      FB.init({
        appId      : '',
        xfbml      : true,
        version    : 'v2.3'
      });
      };

      (function(d, s, id){
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) {return;}
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/sdk.js";
      fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
    </script>
  </header>

  <article class="post-content">
   
      <blockquote>
  <p><em>这一系列的教程写于 F8 2016 app 开发期间，为的是用简单的文字来介绍 React Native 及其开源生态。教程于 2016 年 4 月 13 号发布到 makeitopen.com，内容翔实很有指导意义，<a href="https://github.com/liaohuqiu">我</a> 看了之后花了周六日两天时间，翻译成中文，方便大家学习。</em></p>
</blockquote>

<p>在传统的软件开发周期中，测试经常被当做是开发接近完成后，一个特别的阶段。对于新生的开源框架，这种看法似乎更接近于事实，因为这些项目的发布时，有时没有相关的测试技术。</p>

<p>幸好 Facebook 在开发 React Native 之初就持续地将测试技术放在心中。在这一部分，我们将会展示如何使用 <a href="http://nuclide.io">Nuclide</a>，<a href="http://flowtype.org">Flow</a> 和 <a href="http://facebook.github.io/jest/">Jest</a> 提高你编写的 React Native 的代码质量的。</p>

<h3 id="flow">Flow：使用类型检查以免写出糟糕的代码</h3>

<p><a href="http://flowtype.org">Flow</a> 提供了对 JavaScript 的 <a href="http://flowtype.org/docs/about-flow.html#_">静态类型检查</a>。Flow 允许以一种渐进的方式，逐步将它的特性运用到我们的代码中。当我们仅仅相对部分代码引入类型检查时，这点特别重要，否则我们就要重改整个 app 的代码了。</p>

<p>在 F8 app 中，我们决定从一开始就完全采用 Flow，在每一个必要的地方都加上 <a href="http://flowtype.org/docs/type-annotations.html#_">类型注解</a>，然后 Flow 替我们完成这些检查。</p>

<p>比如，让我来看一个 <a href="/tutorials/building-the-f8-app/data/">数据集成章节</a> 提到的简单的 Action：</p>

<div class="highlighter-rouge"><div class="rougeHighlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="cm">/* from js/actions/login.js */</span>

<span class="cm">/*
 * @flow
 */</span>

<span class="p">...</span>

<span class="kd">function</span> <span class="nx">skipLogin</span><span class="p">()</span><span class="err">:</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'SKIPPED_LOGIN'</span><span class="p">,</span>
  <span class="p">};</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>在第 13 行，我们加了一个 <code class="highlighter-rouge">@flow</code> 标志，让 <a href="http://flowtype.org/docs/getting-started.html#_">Flow 来检查这些代码</a>)。然后，我们用 Flow 的 <a href="http://flowtype.org/docs/type-annotations.html#_">类型注解</a> 来标明 <code class="highlighter-rouge">skipLogin()</code> 的返回值必须是 <code class="highlighter-rouge">Action</code> 类型。但这个类型不是 React Native 或者 Redux 的内置类型，我们需要自己定义：</p>

<div class="highlighter-rouge"><div class="rougeHighlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></td><td class="code"><pre><span class="cm">/* from js/actions/types.js */</span>

<span class="kr">export</span> <span class="nx">type</span> <span class="nx">Action</span> <span class="o">=</span>
    <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'LOADED_ABOUT'</span><span class="p">,</span> <span class="na">list</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">ParseObject</span><span class="o">&gt;</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'LOADED_NOTIFICATIONS'</span><span class="p">,</span> <span class="na">list</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">ParseObject</span><span class="o">&gt;</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'LOADED_MAPS'</span><span class="p">,</span> <span class="na">list</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">ParseObject</span><span class="o">&gt;</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'LOADED_FRIENDS_SCHEDULES'</span><span class="p">,</span> <span class="na">list</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span> <span class="nl">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span> <span class="nl">schedule</span><span class="p">:</span> <span class="p">{[</span><span class="na">key</span><span class="p">:</span> <span class="nx">string</span><span class="p">]:</span> <span class="kr">boolean</span><span class="p">};</span> <span class="p">}</span><span class="o">&gt;</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'LOADED_CONFIG'</span><span class="p">,</span> <span class="na">config</span><span class="p">:</span> <span class="nx">ParseObject</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'LOADED_SESSIONS'</span><span class="p">,</span> <span class="na">list</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">ParseObject</span><span class="o">&gt;</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'LOADED_SURVEYS'</span><span class="p">,</span> <span class="na">list</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nb">Object</span><span class="o">&gt;</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'SUBMITTED_SURVEY_ANSWERS'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'LOGGED_IN'</span><span class="p">,</span> <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span> <span class="nl">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span> <span class="nl">sharedSchedule</span><span class="p">:</span> <span class="p">?</span><span class="kr">boolean</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'RESTORED_SCHEDULE'</span><span class="p">,</span> <span class="na">list</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">ParseObject</span><span class="o">&gt;</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'SKIPPED_LOGIN'</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'LOGGED_OUT'</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'SESSION_ADDED'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="nx">string</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'SESSION_REMOVED'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="nx">string</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'SET_SHARING'</span><span class="p">,</span> <span class="na">enabled</span><span class="p">:</span> <span class="kr">boolean</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'APPLY_TOPICS_FILTER'</span><span class="p">,</span> <span class="na">topics</span><span class="p">:</span> <span class="p">{[</span><span class="na">key</span><span class="p">:</span> <span class="nx">string</span><span class="p">]:</span> <span class="kr">boolean</span><span class="p">}</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'CLEAR_FILTER'</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'SWITCH_DAY'</span><span class="p">,</span> <span class="na">day</span><span class="p">:</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'SWITCH_TAB'</span><span class="p">,</span> <span class="na">tab</span><span class="p">:</span> <span class="s1">'schedule'</span> <span class="o">|</span> <span class="s1">'my-schedule'</span> <span class="o">|</span> <span class="s1">'map'</span> <span class="o">|</span> <span class="s1">'notifications'</span> <span class="o">|</span> <span class="s1">'info'</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'TURNED_ON_PUSH_NOTIFICATIONS'</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'REGISTERED_PUSH_NOTIFICATIONS'</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'SKIPPED_PUSH_NOTIFICATIONS'</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'RECEIVED_PUSH_NOTIFICATION'</span><span class="p">,</span> <span class="na">notification</span><span class="p">:</span> <span class="nb">Object</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'SEEN_ALL_NOTIFICATIONS'</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'RESET_NUXES'</span> <span class="p">}</span>
  <span class="p">;</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>这里，我们创建了一些 <a href="http://flowtype.org/docs/type-aliases.html#_">Flow 的类型别名</a>，<code class="highlighter-rouge">Action</code> 必须只能是这一些列不同的对象形式中的一种。</p>

<p>比如 <code class="highlighter-rouge">SKIPPED_LOGIN</code> 这个 Action 只能包含一个 type 标签；而 <code class="highlighter-rouge">LOADED_SURVEYS</code> Action 出了 type 还必须返回一个列表。</p>

<p>我们可以看到对应的 Action creator 确实也是这样做的：</p>

<div class="highlighter-rouge"><div class="rougeHighlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="cm">/* from js/actions/surveys.js */</span>
<span class="nx">async</span> <span class="kd">function</span> <span class="nx">loadSurveys</span><span class="p">()</span><span class="err">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Action</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">Parse</span><span class="p">.</span><span class="nx">Cloud</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="s1">'surveys'</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'LOADED_SURVEYS'</span><span class="p">,</span>
    <span class="nx">list</span><span class="p">,</span>
  <span class="p">};</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>我们在 app 中用了许多的 Action，强类型检查让我们不至于犯下一些比如拼写错误这样的低级的错误。更为重要的是，数据格式错误时，我们也能及时发现。</p>

<p>对于 Reducer，我们也做了一样的强类型检查：</p>

<div class="highlighter-rouge"><div class="rougeHighlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="cm">/* from js/reducers/surveys.js */</span>
<span class="kd">function</span> <span class="nx">surveys</span><span class="p">(</span><span class="nx">state</span><span class="err">:</span> <span class="nx">State</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">action</span><span class="err">:</span> <span class="nx">Action</span><span class="p">)</span><span class="err">:</span> <span class="nx">State</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'LOADED_SURVEYS'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">action</span><span class="p">.</span><span class="nx">list</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="p">...</span>
  <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>因为 <code class="highlighter-rouge">action</code> 参数指定为了 <code class="highlighter-rouge">Action</code> 类型，Reducer 函数必须使用一个有效的 <code class="highlighter-rouge">action.type</code>。当我们定义 <code class="highlighter-rouge">state</code> 树的部分结构时，我们也使用了类型别名去定义 <code class="highlighter-rouge">state</code> 的结构：</p>

<div class="highlighter-rouge"><div class="rougeHighlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20</pre></td><td class="code"><pre><span class="cm">/* from js/reducers/user.js */</span>
<span class="kr">export</span> <span class="nx">type</span> <span class="nx">State</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">isLoggedIn</span><span class="p">:</span> <span class="kr">boolean</span><span class="p">;</span>
  <span class="nl">hasSkippedLogin</span><span class="p">:</span> <span class="kr">boolean</span><span class="p">;</span>
  <span class="nl">sharedSchedule</span><span class="p">:</span> <span class="p">?</span><span class="kr">boolean</span><span class="p">;</span>
  <span class="nl">id</span><span class="p">:</span> <span class="p">?</span><span class="nx">string</span><span class="p">;</span>
  <span class="nl">name</span><span class="p">:</span> <span class="p">?</span><span class="nx">string</span><span class="p">;</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">initialState</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">isLoggedIn</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">hasSkippedLogin</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">sharedSchedule</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="na">id</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="na">name</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">user</span><span class="p">(</span><span class="nx">state</span><span class="p">:</span> <span class="nx">State</span> <span class="o">=</span> <span class="nx">initialState</span><span class="p">,</span> <span class="nx">action</span><span class="p">:</span> <span class="nx">Action</span><span class="p">):</span> <span class="nx">State</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>在 <a href="/tutorials/building-the-f8-app/data/">数据整合章节</a>，我们看到了这个 <code class="highlighter-rouge">initialState</code> 对象，你现在将会看到，我们是如何让 <code class="highlighter-rouge">state</code> 树的部分去遵从这个 Flow 类型的，任何不满足类型要求的 <code class="highlighter-rouge">state</code>，都会有 Flow 类型检查错误。</p>

<p>Note that Flow checks are run at compile-time only, and the React Native packager</p>

<p>请注意，Flow 的检查只是编译时的。 React Native packager <a href="https://github.com/facebook/react-native/blob/master/babel-preset/configs/main.js#L32">会自动将这些移除</a>。这也就是说，使用 Flow 不会导致运行时的任何性能损失。</p>

<p>当然，目前每次我们想测试代码的时候，我们必须手动运行 <a href="http://flowtype.org/docs/cli.html#_">Flow 命令行</a> 来进行类型检查。但我们也可以用 Nuclide 在 <strong>编码的时候</strong> 来完成这些验证。</p>

<h3 id="nuclidereact-native--ide">Nuclide：React Native 的 IDE</h3>

<p><a href="http://nuclide.io/docs/platforms/react-native/">Nuclide 的网站上</a> 有对其提供的针对 React Native 量身定制的功能的全面介绍。我只想说，Nuclide 确实是开发 React Native 的一流 IDE。是为那些在 Facebook 写 React Native，以及使用 React Native 来开发 app 的人们开发的。</p>

<p>Flow 的集成是我们尤其感兴趣的，我们这里可以看一些 Reducer 中的代码：</p>

<div class="highlighter-rouge"><div class="rougeHighlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'SKIPPED_LOGIN'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">isLoggedIn</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">hasSkippedLogin</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">sharedSchedule</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="na">name</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="p">};</span>
  <span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>之前我们提到，我们会对返回类型进行强制检查。在 Nuclide 中，当错误发生时，我们可以实时地看到：</p>

<video width="1174" height="1002" autoplay="" loop="">
  <source src="static/videos/flow.mp4" type="video/mp4" />
  Your browser does not support the HTML5 video tag.
</video>

<p>在快速开发 app 的过程中，我们可能会不小心地，却又经常地遗漏掉 State 类型的某个部分，现在我们可以及时地得到反馈。</p>

<p>Nuclide 会执行所有的类型检查，我们在写代码的时候，我们就可以发现这些错误并及时更正，而不是等到开发接近完成时，这些错误才暴露出来。</p>

<p>这也许并不直观，但这确实提高了开发速度。要想发现没有写的，被遗漏的代码，相当困难。在 app 都接近开发完成时，面对一大堆代码，这变得更加麻烦。</p>

<h3 id="jest-">Jest: 单元测试</h3>

<p><a href="http://facebook.github.io/jest/">Jest</a> 是针对 JavaScript 的一套测试框架，用它来做 <a href="http://facebook.github.io/react-native/docs/testing.html#content">React Native 的测试</a> 效果不错。</p>

<p>我们用这些单元测试来做回归测试，确保已经完成的功能性代码，不会引入新的 bug。</p>

<p>比如我们想用一个单元测试来保证 Reducer 能够正确地处理地图数据：</p>

<div class="highlighter-rouge"><div class="rougeHighlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre><span class="nx">jest</span><span class="p">.</span><span class="nx">autoMockOff</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">Parse</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'parse'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">maps</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../maps'</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'maps reducer'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'is empty by default'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">maps</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="p">{})).</span><span class="nx">toEqual</span><span class="p">([]);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'populates maps from server'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">Parse</span><span class="p">.</span><span class="nb">Object</span><span class="p">({</span><span class="na">mapTitle</span><span class="p">:</span> <span class="s1">'Day 1'</span><span class="p">,</span> <span class="na">mapImage</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Parse</span><span class="p">.</span><span class="nx">File</span><span class="p">(</span><span class="s1">'1.png'</span><span class="p">)}),</span>
      <span class="k">new</span> <span class="nx">Parse</span><span class="p">.</span><span class="nb">Object</span><span class="p">({</span><span class="na">mapTitle</span><span class="p">:</span> <span class="s1">'Day 2'</span><span class="p">,</span> <span class="na">mapImage</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Parse</span><span class="p">.</span><span class="nx">File</span><span class="p">(</span><span class="s1">'2.png'</span><span class="p">)}),</span>
    <span class="p">];</span>

    <span class="nx">expect</span><span class="p">(</span>
      <span class="nx">maps</span><span class="p">([],</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'LOADED_MAPS'</span><span class="p">,</span> <span class="nx">list</span><span class="p">})</span>
    <span class="p">).</span><span class="nx">toEqual</span><span class="p">([{</span>
      <span class="na">id</span><span class="p">:</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span>
      <span class="na">title</span><span class="p">:</span> <span class="s1">'Day 1'</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="s1">'1.png'</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="na">id</span><span class="p">:</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span>
      <span class="na">title</span><span class="p">:</span> <span class="s1">'Day 2'</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="s1">'2.png'</span><span class="p">,</span>
    <span class="p">}]);</span>
  <span class="p">});</span>

<span class="p">});</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Jest 简单易读，但我们还是会做进一步的分解。</p>

<p>在第 4 行，我们引入了地图的 Reducer 函数 <code class="highlighter-rouge">js/reducers/maps.js</code>，以便我们可以在单元测试中用到。因为 Reducer 函数是 <a href="https://en.wikipedia.org/wiki/Pure_function">pure functions</a>，所以很容易进行测试。</p>

<p>第 8 行的测试代码，确保返回一个空数组。因为在 <code class="highlighter-rouge">js/reducers/maps.js</code> 我们没有定义初始的 <code class="highlighter-rouge">state</code>，所以返回一个空数组就好了。</p>

<p>第 12 行，我们用假数据来替换 API 返回的数据来进行测试，确保数据可以被 Reducer 转换成正确的 <code class="highlighter-rouge">state</code> 结构。这可避免因为 API 的网络原因导致测试失败。</p>

<p>现在我们已经把单元测试变为开发流程中的一部分了，比如我们会在 Git 提交前做检查。这样我们就可以保证我们的代码变更不会使得 app 默默地就挂掉了。</p>

<p>只有 Redux Reducer 改变 <code class="highlighter-rouge">state</code> 树对于没有 bug 被引入是至关重要的。即使有，关于 <code class="highlighter-rouge">state</code> 改变的 bug 也不会导致功能不可用，仅仅是错误的数据被发送到 Parse Server 罢了。</p>

<p>Reducer 的 pure function 性质，使得他们成为回归测试的理想对象，因为每次我们都可以预知他们的返回值。</p>

<h3 id="section">调试</h3>

<p>如果你想定位或者修复一个 bug，如果手边有些工具可用的话，那就最好了。上一章节，我们提到 <a href="/tutorials/building-the-f8-app/design/#the-design-iteration-cycle">如果调整 UI 元素</a>，那么对于数据呢？</p>

<p>我们使用 <a href="https://facebook.github.io/react-native/docs/debugging.html#chrome-developer-tools">Chrome 的开发者工具</a> 通过 <a href="http://nuclide.io/docs/features/debugger/">Nuclide</a> 和 <a href="http://fcomb.github.io/redux-logger/">Redux Logger</a> middleware 在控制台查看信息。</p>

<p><img src="static/images/redux_logger.png" alt="Redux Logger Middleware in action with additional console context" /></p>

<p>在 <code class="highlighter-rouge">configureStore</code> 中，你可以看到我们是如果设置的：</p>

<div class="highlighter-rouge"><div class="rougeHighlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20</pre></td><td class="code"><pre><span class="cm">/* from js/store/configureStore.js */</span>
<span class="kd">var</span> <span class="nx">createLogger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'redux-logger'</span><span class="p">);</span>
<span class="p">...</span>
<span class="kd">var</span> <span class="nx">isDebuggingInChrome</span> <span class="o">=</span> <span class="nx">__DEV__</span> <span class="o">&amp;&amp;</span> <span class="o">!!</span><span class="nb">window</span><span class="p">.</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">createLogger</span><span class="p">({</span>
  <span class="na">predicate</span><span class="p">:</span> <span class="p">(</span><span class="nx">getState</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">isDebuggingInChrome</span><span class="p">,</span>
  <span class="na">collapsed</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">duration</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">createF8Store</span> <span class="o">=</span> <span class="nx">applyMiddleware</span><span class="p">(</span><span class="nx">thunk</span><span class="p">,</span> <span class="nx">promise</span><span class="p">,</span> <span class="nx">array</span><span class="p">,</span> <span class="nx">logger</span><span class="p">)(</span><span class="nx">createStore</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">configureStore</span><span class="p">(</span><span class="nx">onComplete</span><span class="err">:</span> <span class="p">?()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">autoRehydrate</span><span class="p">()(</span><span class="nx">createF8Store</span><span class="p">)(</span><span class="nx">reducers</span><span class="p">);</span>
  <span class="nx">persistStore</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span> <span class="p">{</span><span class="na">storage</span><span class="p">:</span> <span class="nx">AsyncStorage</span><span class="p">},</span> <span class="nx">onComplete</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isDebuggingInChrome</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">store</span> <span class="o">=</span> <span class="nx">store</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">store</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>第 5 行，我们使用 <a href="https://github.com/fcomb/redux-logger#options-1">一些选项</a> 创建了 Logger middleware。 在第 10 行，我们通过 Redux 的 <a href="http://redux.js.org/docs/api/applyMiddleware.html"><code class="highlighter-rouge">applyMiddleware()</code> 函数</a> 作用到了 Store 上。这样控制台就会有日志输出了。</p>

<p>在第 4 行，我们使用一个 <a href="http://www.w3schools.com/js/js_scope.asp">全局变量</a> <code class="highlighter-rouge">__DEV__</code> 来控制是否开启一些调试功能。比如创建 Logger middleware，并开启<a href="https://github.com/fcomb/redux-logger#predicate--getstate-function-action-object--boolean"><code class="highlighter-rouge">predicate（断言）</code> 选项</a>) 来记录日志；比如 17 行，将 Store 拷贝到 <a href="http://www.w3schools.com/jsref/obj_window.asp">Window object</a>，这样就可以在控制台方便地直接查看 Store 对象了。</p>


    
  </article>
  








<div class="postPagination">

<div class="pagingLink previousLink">
  <a href="/tutorials/building-the-f8-app/data/">
    <i>&lsaquo;</i>
    <span>数据集成</span>
  </a>
</div>



<div class="pagingLink nextLink">
  <a href="/tutorials/building-the-f8-app/local-setup/">
    <span>本地设置运行 App</span>
    <i>&rsaquo;</i>
  </a>
</div>

</div>




</div>

    <div>
</div>
<nav class='toc' id="doc_nav"></nav>
<script>
  
  var docnavData = [
    {
      group     : "构建 F8 2016 App",
      items     : [
        
        
        {
          key : "/tutorials/building-the-f8-app/planning/",
          title : "App 的筹备",
          type: "",
          partlabel : "第一章",
          url : "/tutorials/building-the-f8-app/planning/",
        },
        
        
        {
          key : "/tutorials/building-the-f8-app/design/",
          title : "应用的多平台设计",
          type: "",
          partlabel : "第二章",
          url : "/tutorials/building-the-f8-app/design/",
        },
        
        
        {
          key : "/tutorials/building-the-f8-app/data/",
          title : "数据集成",
          type: "",
          partlabel : "第三章",
          url : "/tutorials/building-the-f8-app/data/",
        },
        
        
        {
          key : "/tutorials/building-the-f8-app/testing/",
          title : "测试",
          type: "",
          partlabel : "第四章",
          url : "/tutorials/building-the-f8-app/testing/",
        },
        
        
        {
          key : "/tutorials/building-the-f8-app/local-setup/",
          title : "本地设置运行 App",
          type: "appendix",
          partlabel : "附录 1",
          url : "/tutorials/building-the-f8-app/local-setup/",
        },
        
        
        {
          key : "/tutorials/building-the-f8-app/relay/",
          title : "使用 Relay 和 GraphQL",
          type: "appendix",
          partlabel : "附录 2",
          url : "/tutorials/building-the-f8-app/relay/",
        },
        
        
        {
          key : "/tutorials/building-the-f8-app/windows/",
          title : "移植 F8 App 到 Windows",
          type: "appendix",
          partlabel : "附录 3",
          url : "/tutorials/building-the-f8-app/windows/",
        }
        
      ],
    },
  ];
</script>
<script type="text/javascript">
  var DocNav = React.createClass({displayName: "DocNav",
    getInitialState: function() {
      return {
        toggleActive: false,
      };
    },
    getDefaultProps: function() {
      return {
        currentDoc: "测试",
        currentGroup: "构建 F8 2016 App",
        data: docnavData,
      }
    },
    handleSlide: function(id) {
      this.setState({
        toggleActive: !this.state.toggleActive,
      });
    },
    render: function() {
      var classes = React.addons.classSet({
        'navToggle': true,
        'navToggleActive': this.state.toggleActive,
      });
      var navClasses = React.addons.classSet({
        'toggleNav': true,
        'toggleNavActive': this.state.toggleActive,
      });
      return (
        React.createElement("div", {className: navClasses},
          React.createElement("section", null,
            this.props.data.map(this.renderNavGroups)
          ),
          React.createElement("div", {className: classes, onClick: this.handleSlide},
            React.createElement("span", null, "目录"), React.createElement("i", null, String.fromCharCode(43))
          )
        )
      );
    },
    renderNavGroups: function(child, index) {
      var classes = React.addons.classSet({
        'navGroup': true,
        'navGroupActive': this.props.currentGroup === child.group,
      });
      return (
        React.createElement("div", {className: classes, key: index},
          React.createElement("h3", null, "目录"),
          React.createElement("ul", null,
            child.items.map(this.renderNavItems)
          )
        )
      );
    },
    renderNavItems: function(child, index) {
      var itemClasses = React.addons.classSet({
        'navListItem': true,
        'navListItemActive': this.props.currentDoc === child.title,
        'navListItemAppendix': child.type === 'appendix',
      });
      var classes = React.addons.classSet({
        'navItem': true,
        'navItemActive': this.props.currentDoc === child.title,
      });
      return (
        React.createElement("li", {className: itemClasses, key: index}, React.createElement("a", {className: classes, href: child.url},  child.partlabel +': '+ child.title))
      );
    },
  });

  function docNavRender(docnavData) {
    React.render(
      React.createElement(DocNav, {data: docnavData}),
      document.getElementById('doc_nav')
    );
  }
  docNavRender(docnavData);
</script>

  </div>
</div>


      <div class="footerContainer">
  <div id="footer_wrap" class="wrapper footerWrapper">
    <div class="footerBlocks">
      <div id="fb_oss" class="footerSection fbOpenSourceFooter">
          <svg class="facebookOSSLogoSvg" viewBox="0 0 1133.9 1133.9" x="0px" y="0px">
            <g>
              <path class="logoRing outerRing" d="M 498.3 3.7 c 153.6 88.9 307.3 177.7 461.1 266.2 c 7.6 4.4 10.3 9.1 10.3 17.8 c -0.3 179.1 -0.2 358.3 0 537.4 c 0 8.1 -2.4 12.8 -9.7 17.1 c -154.5 88.9 -308.8 178.1 -462.9 267.5 c -9 5.2 -15.5 5.3 -24.6 0.1 c -153.9 -89.2 -307.9 -178 -462.1 -266.8 C 3 838.8 0 833.9 0 825.1 c 0.3 -179.1 0.2 -358.3 0 -537.4 c 0 -8.6 2.6 -13.6 10.2 -18 C 164.4 180.9 318.4 92 472.4 3 C 477 -1.5 494.3 -0.7 498.3 3.7 Z M 48.8 555.3 c 0 79.9 0.2 159.9 -0.2 239.8 c -0.1 10 3 15.6 11.7 20.6 c 137.2 78.8 274.2 157.8 411 237.3 c 9.9 5.7 17 5.7 26.8 0.1 c 137.5 -79.8 275.2 -159.2 412.9 -238.5 c 7.4 -4.3 10.5 -8.9 10.5 -17.8 c -0.3 -160.2 -0.3 -320.5 0 -480.7 c 0 -8.8 -2.8 -13.6 -10.3 -18 C 772.1 218 633.1 137.8 494.2 57.4 c -6.5 -3.8 -11.5 -4.5 -18.5 -0.5 C 336.8 137.4 197.9 217.7 58.8 297.7 c -7.7 4.4 -10.2 9.2 -10.2 17.9 C 48.9 395.5 48.8 475.4 48.8 555.3 Z" />
              <path class="logoRing middleRing" d="M 184.4 555.9 c 0 -33.3 -1 -66.7 0.3 -100 c 1.9 -48 24.1 -86 64.7 -110.9 c 54.8 -33.6 110.7 -65.5 167 -96.6 c 45.7 -25.2 92.9 -24.7 138.6 1 c 54.4 30.6 108.7 61.5 162.2 93.7 c 44 26.5 67.3 66.8 68 118.4 c 0.9 63.2 0.9 126.5 0 189.7 c -0.7 50.6 -23.4 90.7 -66.6 116.9 c -55 33.4 -110.8 65.4 -167.1 96.5 c -43.4 24 -89 24.2 -132.3 0.5 c -57.5 -31.3 -114.2 -64 -170 -98.3 c -41 -25.1 -62.9 -63.7 -64.5 -112.2 C 183.5 621.9 184.3 588.9 184.4 555.9 Z M 232.9 556.3 c 0 29.5 0.5 59.1 -0.1 88.6 c -0.8 39.2 16.9 67.1 50.2 86.2 c 51.2 29.4 102.2 59.2 153.4 88.4 c 31.4 17.9 63.6 18.3 95 0.6 c 53.7 -30.3 107.1 -61.2 160.3 -92.5 c 29.7 -17.5 45 -44.5 45.3 -78.8 c 0.6 -61.7 0.5 -123.5 0 -185.2 c -0.3 -34.4 -15.3 -61.5 -44.9 -79 C 637.7 352.6 583 320.8 527.9 290 c -27.5 -15.4 -57.2 -16.1 -84.7 -0.7 c -56.9 31.6 -113.4 64 -169.1 97.6 c -26.4 15.9 -40.7 41.3 -41.1 72.9 C 232.6 491.9 232.9 524.1 232.9 556.3 Z" />
              <path class="logoRing innerRing" d="M 484.9 424.4 c 69.8 -2.8 133.2 57.8 132.6 132 C 617 630 558.5 688.7 484.9 689.1 c -75.1 0.4 -132.6 -63.6 -132.7 -132.7 C 352.1 485 413.4 421.5 484.9 424.4 Z M 401.3 556.7 c -3.4 37.2 30.5 83.6 83 84.1 c 46.6 0.4 84.8 -37.6 84.9 -84 c 0.1 -46.6 -37.2 -84.4 -84.2 -84.6 C 432.2 472.1 397.9 518.3 401.3 556.7 Z" />
            </g>
          </svg>
        <h2><a class="footerLink" href="https://code.facebook.com/projects/" target="_blank">Facebook Open Source</a></h2>
      </div>
      <div class="footerSection rightAlign">
        <a class="footerLink" href="https://github.com/liaohuqiu/f8-app-tutorial-cn" target="_blank">本文档 GitHub 项目</a>
      </div>
    </div>
  </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43024238-14', 'auto');
  ga('send', 'pageview');

</script>


    </div>
  </body>

</html>
